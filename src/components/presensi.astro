---
const today = new Date();
const day = today.getDay(); // 0 = Minggu, 1 = Senin, 2 = Selasa, ...
const isMonday = day === 1;
---

<div id="comp-presensi" class="hidden px-4 py-16">
    <div class="flex flex-col gap-4 justify-center items-center">
        <p>(WFA terbuka apabila sudah mengirim titik lokasi rumah)</p>
        <select name="workfrom" class="w-[300px] border-2 border-indigo-700">
            {
                isMonday ? (
                    <option value="WFA">WFA</option>
                ) : (
                    <option value="WFO">WFO</option>
                )
            }
        </select>
        <button
            id="btn-presensi"
            class="py-2 px-4 bg-green-700 text-green-50 rounded-md hover:opacity-85"
            >Presensi</button
        >
    </div>
</div>

<script>
    import { getCookie, removeCookie } from "../lib/storage";
    import { servicePresensi } from "../services/bkn";
    import Swal from "sweetalert2";

    const btnPresensi = document.getElementById(
        "btn-presensi",
    ) as HTMLButtonElement;

    const formWorkFrom = document.querySelector(
        'select[name="workfrom"]',
    ) as HTMLSelectElement;

    const comp = document.getElementById("comp-presensi") as HTMLDivElement;

    const main = async () => {
        const check = getCookie("isVerif");
        if (check) {
            comp.classList.remove("hidden");
        }
    };

    const sleep = (ms: number): Promise<void> => {
        return new Promise((resolve) => setTimeout(resolve, ms));
    };

    btnPresensi.addEventListener("click", async () => {
        // Tampilkan loading
        Swal.fire({
            title: "Memproses presensi...",
            text: "Mohon tunggu sebentar",
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            },
        });

        try {
            const workfrom = formWorkFrom.value == "WFA" ? "WFA" : "WFO";
            await sleep(1500); // Simulasi delay
            const data = await servicePresensi(workfrom);
            Swal.close(); // Tutup loading

            // Cek apakah response berhasil
            if (!data?.status) {
                Swal.fire({
                    title: "Presensi Gagal",
                    text: data?.message || "Terjadi kesalahan saat presensi",
                    icon: "error",
                });
                return;
            }

            Swal.fire({
                title: "Presensi Berhasil",
                text: data?.message || "Anda berhasil melakukan presensi",
                icon: "success",
            });

            removeCookie("isVerif");

            setTimeout(() => {
                window.location.reload();
            }, 1500);

            // Kalau perlu, update UI (misalnya isi <ul>)
        } catch (error) {
            Swal.close();
            Swal.fire({
                title: "Terjadi Kesalahan",
                text: "Tidak dapat menghubungi server presensi",
                icon: "error",
            });
            console.error("Presensi error:", error);
        }
    });

    main();
</script>
