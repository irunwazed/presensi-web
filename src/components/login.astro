<!-- Pastikan Tailwind sudah di-include di project kamu, contoh via CDN: -->
<!-- <script src="https://cdn.tailwindcss.com"></script> -->

<div class="max-w-md mx-auto mt-20 p-8 border border-gray-300 rounded-lg shadow-lg font-sans bg-white">
  <form action="" method="post" id="form-login" class="flex flex-col space-y-6">
    <div>
      <label for="username" class="block mb-2 text-gray-700 font-semibold">Username</label>
      <input type="text" name="username" id="username" required
        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label for="password" class="block mb-2 text-gray-700 font-semibold">Password</label>
      <input type="password" name="password" id="password" required
        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label for="totp" class="block mb-2 text-gray-700 font-semibold">TOTP</label>
      <input type="text" name="totp" id="totp" required
        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>

    <button type="submit"
      class="bg-blue-600 text-white font-semibold py-3 rounded-md hover:bg-blue-700 transition-colors duration-300">
      Masuk
    </button>
  </form>
</div>

<script type="module">
  import { saveProfile } from "../lib/storage";
  import { serviceLogin, serviceProfile } from "../services/bkn";
  import Swal from "sweetalert2";

  const form = document.getElementById("form-login");
  const username = document.querySelector('input[name="username"]');
  const password = document.querySelector('input[name="password"]');
  const totp = document.querySelector('input[name="totp"]');

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    Swal.fire({
      title: "Loading...",
      text: "Sedang memproses login, harap tunggu.",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    try {
      const check = await serviceLogin(username.value, password.value, totp.value);

      if (check.status) {
        const data = await serviceProfile(username.value);
        saveProfile(
          data?.data?.nip,
          data?.data?.nama,
          data?.data?.jabatan,
          parseInt(data?.data?.radius),
          parseInt(data?.data?.radiusWFH),
        );

        Swal.fire({
          title: "Berhasil",
          text: check.message,
          icon: "success",
        });

        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } else {
        Swal.fire({
          title: "Gagal",
          text: check.message,
          icon: "error",
        });
      }
    } catch (error) {
      Swal.fire({
        title: "Error",
        text: "Terjadi kesalahan, coba lagi nanti.",
        icon: "error",
      });
      console.error(error);
    }
  });
</script>
