<input type="file" id="fileInput" accept="image/*" />
<br />
<textarea id="base64Output" class="hidden" rows="10" cols="60" readonly></textarea>
<br />
<img id="preview" alt="Preview Image" />

<button id="btn-face" class="py-2 px-4 bg-orange-700 text-orange-50 rounded-md hover:opacity-85">kirim</button>

<script>
    import { serviceFaceverification } from "../services/bkn";
    import Swal from "sweetalert2";

    const fileInput = document.getElementById("fileInput") as HTMLInputElement;
    const preview = document.getElementById("preview") as HTMLImageElement;
    const base64Output = document.getElementById(
        "base64Output",
    ) as HTMLTextAreaElement;
    const btnFace = document.getElementById("btn-face") as HTMLButtonElement;

    fileInput.addEventListener("change", (event: any) => {
        const file = event?.target?.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement("canvas");
                canvas.width = 450;
                canvas.height = 600;

                const ctx = canvas.getContext("2d");
                ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);

                const dataURL = canvas.toDataURL("image/jpeg", 0.8);

                preview.src = dataURL;
                preview.width = 450;
                preview.height = 600;

                // ambil base64 pure (buang prefix data:image/jpeg;base64,)
                const base64 = dataURL.split(",")[1];

                base64Output.value = "data:image/jpeg;base64," + base64;
            };
            img.src = e?.target?.result?.toString() ?? "";
        };

        reader.readAsDataURL(file);
    });

    btnFace.addEventListener("click", async () => {
        if (base64Output.value == "") {
            alert("kosong");
            return;
        }

        Swal.fire({
            title: "Memproses...",
            text: "Mohon tunggu sebentar",
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            },
        });

        try {
            const face = await serviceFaceverification(base64Output.value);

            // Tutup loading
            Swal.close();

            if (!face.status) {
                Swal.fire({
                    title: "Gagal",
                    text: face.message || "Verifikasi wajah gagal",
                    icon: "error",
                });
            } else {
                Swal.fire({
                    title: "Sukses",
                    text: "Berhasil verifikasi wajah",
                    icon: "success",
                });
            }
        } catch (error) {
            Swal.close();
            Swal.fire({
                title: "Terjadi Kesalahan",
                text: "Gagal memproses verifikasi wajah",
                icon: "error",
            });
            console.error(error);
        }
    });
</script>
